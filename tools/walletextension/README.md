# Wallet extension

The wallet extension is an HTTP server that sits between the Obscuro client and the Obscuro host. It encrypts outgoing 
requests with the enclave public key, and decrypts any encrypted responses from the enclave (i.e. responses to 
`eth_getBalance` and `eth_call` requests) with a _viewing key_.

A _viewing key_ is a public key generated by the wallet extension. The public key is sent to the enclave, accompanied 
by a signature proving the public key was generated by a specific account. The private key is stored locally by the 
wallet extension. This viewing key and its corresponding private key are then used to securely encrypt messages from 
the enclave to the wallet extension.

The signature over the viewing key is created using [MetaMask](https://metamask.io/). Currently, other signers are not 
supported.

The wallet extension should ideally be run locally, such that no sensitive data leaves the client's machine 
unencrypted. If the data is not particularly sensitive, it can also be run in another trusted location.

## Obscuro facade

The Obscuro facade is an additional tool that sits between the wallet extension and a regular Ethereum node. It 
decrypts requests using the enclave public key, and encrypts sensitive responses using the viewing key. It uses the 
viewing key associated with the `from` field in an `eth_call` request, or the address field in an `eth_getBalance` 
request. In this way, it allows a regular Ethereum node to behave like an Obscuro node, in terms of secure messaging.

## Usage

* Install MetaMask in your browser

* Run `walletextension/main/main()` with the following flags to start the wallet extension and Obscuro facade:

  ```--localNetwork --prefundedAccounts=<account_1_address>,<account_2_address>,<...>```

  Where each account address is a 42-character hexadecimal address (e.g. `0x41F534DB02c6953FB6d9Bd9Eff8B55C364819700`).

  This will create a new local network and connect the wallet extension and Obscuro facade to it. The wallet extension 
  is listening on `http://localhost:3000/`

  * If you want to use an existing network instead of a new local network, remove the `--localNetwork` and 
    `--prefundedAccounts` flags, and ensure that a node on your existing network can be reached on `ws://localhost:8546`

  * In MetaMask, configure a new custom network, using `http://localhost:3000/` as the "New RPC URL". Requests and 
    responses for the network will now pass through the wallet extension, with requests encrypted with the enclave 
    public key

    * A viewing key has not yet been set up. The enclave will refuse to respond to `eth_getBalance` and 
        `eth_getStorageAt` requests

  * Visit `http://localhost:3000/viewingkeys/` to generate a new viewing key. Sign the viewing key when prompted by 
    MetaMask. Responses to `eth_getBalance` and `eth_getStorageAt` requests will be now be sent encrypted with the 
    viewing key and decrypted automatically by the wallet extension

    * Viewing keys are ephemeral. A new viewing key must be created each time the wallet extension is started
